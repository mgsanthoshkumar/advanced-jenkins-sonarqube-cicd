version: '3.8'

# --- Volumes for Data Persistence ---
volumes:
  jenkins_home:
  sonarqube_data:
  prometheus_data:
  grafana_data:

# --- Shared Network ---
networks:
  devops-net:
    driver: bridge

# --- Service Definitions ---
services:
  # 1. Jenkins CI Server (Orchestration)
  jenkins:
    image: jenkins/jenkins:lts-jdk17
    privileged: true
    user: root
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      # CRITICAL: Mounts your local project folder into the container for file access
      - /home/hr265/sample-app:/host_project 
    networks:
      - devops-net
    container_name: jenkins
    restart: unless-stopped

  # 2. SonarQube Code Quality Server
  sonarqube:
    image: sonarqube:lts-community
    environment:
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true
    ports:
      # Using 9001 on the host to avoid port conflicts (internal is 9000)
      - "9001:9000" 
    volumes:
      - sonarqube_data:/opt/sonarqube/data
    networks:
      - devops-net
    container_name: sonarqube
    restart: unless-stopped

  # 3. Prometheus Monitoring
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - devops-net
    container_name: prometheus
    restart: unless-stopped

  # 4. Grafana Observability/Visualization
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
    networks:
      - devops-net
    container_name: grafana
    restart: unless-stopped

  # 5. Application Deployment Target (Simulated Staging/Prod Server)
  app-target:
    image: alpine:latest
    # CRITICAL FIX: Use tail -f /dev/null to keep the container permanently stable (Running)
    command: tail -f /dev/null 
    ports:
      - "80:80" 
    networks:
      - devops-net
    container_name: app-target
    restart: unless-stopped

